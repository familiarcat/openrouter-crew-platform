name: Secrets Audit

on:
  schedule:
    # Run monthly on the 1st at 9 AM UTC
    - cron: '0 9 1 * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of audit to run'
        required: true
        type: choice
        options:
          - quick
          - comprehensive
        default: quick

jobs:
  audit-secrets:
    name: Audit GitHub Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required secrets
        env:
          CHECK_TYPE: ${{ github.event.inputs.check_type || 'quick' }}
        run: |
          echo "## ðŸ” Secrets Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Audit type**: $CHECK_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List of required secrets
          REQUIRED_SECRETS=(
            "AWS_ACCESS_KEY_ID"
            "AWS_SECRET_ACCESS_KEY"
            "EC2_INSTANCE_ID"
            "EC2_PUBLIC_IP"
            "SUPABASE_URL"
            "SUPABASE_ANON_KEY"
            "SUPABASE_SERVICE_ROLE_KEY"
            "SUPABASE_DB_PASSWORD"
            "OPENROUTER_API_KEY"
            "N8N_BASE_URL"
            "N8N_API_KEY"
            "N8N_ENCRYPTION_KEY"
            "REDIS_PASSWORD"
          )

          echo "### Required Secrets Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY

          ALL_PRESENT=true

          for secret in "${REQUIRED_SECRETS[@]}"; do
            # Check if secret is set (non-empty)
            if [ -z "${!secret}" ]; then
              echo "| $secret | âŒ Missing |" >> $GITHUB_STEP_SUMMARY
              ALL_PRESENT=false
            else
              echo "| $secret | âœ… Present |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$ALL_PRESENT" = true ]; then
            echo "### âœ… All Required Secrets Present" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Some Secrets Missing" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run: \`bash scripts/secrets/setup-github-secrets.sh\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Test AWS credentials
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-2
        run: |
          echo "### AWS Credentials Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if aws sts get-caller-identity; then
            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            USER_ARN=$(aws sts get-caller-identity --query Arn --output text)
            echo "âœ… **Valid AWS credentials**" >> $GITHUB_STEP_SUMMARY
            echo "- Account: \`$ACCOUNT_ID\`" >> $GITHUB_STEP_SUMMARY
            echo "- User: \`$USER_ARN\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Invalid AWS credentials**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Test Supabase connection
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "### Supabase Connection Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            "$SUPABASE_URL/rest/v1/")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… **Supabase connection successful**" >> $GITHUB_STEP_SUMMARY
            echo "- URL: \`$SUPABASE_URL\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Supabase connection failed** (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Test OpenRouter API
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          echo "### OpenRouter API Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $OPENROUTER_API_KEY" \
            "https://openrouter.ai/api/v1/auth/key")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… **OpenRouter API key valid**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **OpenRouter API key invalid** (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check EC2 instance
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-2
          EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
        run: |
          echo "### EC2 Instance Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if aws ec2 describe-instances \
            --instance-ids "$EC2_INSTANCE_ID" \
            --query 'Reservations[0].Instances[0].[State.Name,InstanceType,PublicIpAddress]' \
            --output text > /tmp/ec2-status.txt; then

            STATE=$(awk '{print $1}' /tmp/ec2-status.txt)
            TYPE=$(awk '{print $2}' /tmp/ec2-status.txt)
            IP=$(awk '{print $3}' /tmp/ec2-status.txt)

            echo "âœ… **EC2 instance found**" >> $GITHUB_STEP_SUMMARY
            echo "- Instance ID: \`$EC2_INSTANCE_ID\`" >> $GITHUB_STEP_SUMMARY
            echo "- State: \`$STATE\`" >> $GITHUB_STEP_SUMMARY
            echo "- Type: \`$TYPE\`" >> $GITHUB_STEP_SUMMARY
            echo "- Public IP: \`$IP\`" >> $GITHUB_STEP_SUMMARY

            if [ "$STATE" != "running" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Warning**: Instance is not running" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **EC2 instance not found**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Comprehensive audit
        if: github.event.inputs.check_type == 'comprehensive'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-2
        run: |
          echo "### ðŸ” Comprehensive Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check IAM permissions
          echo "#### IAM Permissions" >> $GITHUB_STEP_SUMMARY
          aws iam get-user 2>/dev/null || echo "- Using assumed role" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check ECR repositories
          echo "#### ECR Repositories" >> $GITHUB_STEP_SUMMARY
          if aws ecr describe-repositories --query 'repositories[*].repositoryName' --output text; then
            echo "âœ… ECR accessible" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No ECR repositories or access denied" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check SSM access
          echo "#### SSM Access" >> $GITHUB_STEP_SUMMARY
          if aws ssm describe-instance-information --query 'InstanceInformationList[*].[InstanceId,PingStatus]' --output text; then
            echo "âœ… SSM accessible" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No SSM instances or access denied" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“š Resources" >> $GITHUB_STEP_SUMMARY
          echo "- [Secrets Setup Guide](../docs/SECRETS_SETUP.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Deployment Guide](../docs/DEPLOYMENT.md)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next audit**: $(date -d '+1 month' -u +"%Y-%m-%d")" >> $GITHUB_STEP_SUMMARY
