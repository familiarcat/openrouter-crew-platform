{
  "name": "CREW - Chief Miles O'Brien - Pragmatic Solutions - OpenRouter - Production",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "crew-chief-obrien",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "crew_directive",
      "name": "Chief O'Brien Directive",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 304],
      "webhookId": "f3cbab01-d75b-4e6f-993f-9f934123c6d6"
    },
    {
      "parameters": {
        "authentication": "genericCredentialType",
        "url": "https://rpkkkbufdwxmjaerbhbn.supabase.co/rest/v1/crew_memories?crew_member=eq.chief_obrien&order=created_at.desc&limit=10",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.SUPABASE_API_KEY }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.SUPABASE_API_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "id": "memory_retrieval",
      "name": "O'Brien Memory Retrieval",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [464, 112],
      "credentials": {
        "httpHeaderAuth": {
          "id": "supabase_api_auth",
          "name": "Supabase API Auth"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Chief O'Brien's Pragmatic Analysis Engine\n// Analyzes user request and provides field-tested, practical insights\n\nconst userRequest = $input.first().json.userRequest || '';\nconst context = $input.first().json.context || {};\nconst memories = $input.all()[1]?.json || [];\n\n// O'Brien's pragmatic filters\nconst isOverEngineered = /complex|architecture|framework|abstract|theoretical/.test(userRequest.toLowerCase());\nconst needsQuickFix = /quick|fast|now|urgent|asap|broken/.test(userRequest.toLowerCase());\nconst questioningNecessity = /need|necessary|required|must have/.test(userRequest.toLowerCase());\n\n// Extract relevant memories (practical solutions)\nconst relevantMemories = memories\n  .filter(m => m.memory_type === 'solution' || m.memory_type === 'fix')\n  .slice(0, 5)\n  .map(m => `- ${m.content}`);\n\nreturn {\n  userRequest,\n  context,\n  analysis: {\n    isOverEngineered,\n    needsQuickFix,\n    questioningNecessity,\n    pragmaticScore: (needsQuickFix ? 2 : 0) + (isOverEngineered ? 1 : 0),\n    relevantExperience: relevantMemories.join('\\n') || 'Fresh problem - will apply first principles'\n  },\n  chiefMode: needsQuickFix ? 'urgent_fix' : isOverEngineered ? 'simplify' : 'standard'\n};"
      },
      "id": "pragmatic_analysis",
      "name": "Pragmatic Analysis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [688, 112]
    },
    {
      "parameters": {
        "authentication": "genericCredentialType",
        "url": "https://api.openrouter.ai/api/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.OPENROUTER_API_KEY }}"
            },
            {
              "name": "HTTP-Referer",
              "value": "https://alex-ai-universal.com"
            },
            {
              "name": "X-Title",
              "value": "Alex AI - Chief O'Brien"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "anthropic/claude-3.7-sonnet:beta"
            },
            {
              "name": "messages",
              "value": "={{ [\n  {\n    role: 'system',\n    content: \"You are Senior Chief Petty Officer Miles O'Brien, the highest-ranking enlisted engineer in the Engineering department. You work alongside Lieutenant Commander Geordi La Forge - while Geordi directs strategy and architecture, you handle the hands-on implementation that makes things actually work. With 25+ years of field engineering experience, you're known for pragmatic, no-nonsense solutions. You value function over form, simplicity over complexity, and action over endless planning. You have little patience for over-engineering and always suggest the most direct path to a working solution. When others propose complex architectures, you ask 'Do we really need all that?' and suggest simpler approaches. Your experience includes making impossible things work on DS9, jury-rigging solutions under pressure, and maintaining systems with practical fixes. Your motto: 'Simple solutions are usually the best solutions.' Be direct, practical, and draw on your field experience.\"\n  },\n  {\n    role: 'user',\n    content: `User Request: ${$json.userRequest}\\n\\nContext: ${JSON.stringify($json.context, null, 2)}\\n\\nRelevant Experience:\\n${$json.analysis.relevantExperience}\\n\\nPragmatic Mode: ${$json.chiefMode}\\n\\nProvide your practical, field-tested advice. Focus on what works, not what's theoretically perfect.`\n  }\n] }}"
            },
            {
              "name": "temperature",
              "value": "0.6"
            },
            {
              "name": "max_tokens",
              "value": "2000"
            }
          ]
        },
        "options": {}
      },
      "id": "crew_ai",
      "name": "Chief O'Brien AI Agent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [912, 304],
      "credentials": {
        "httpHeaderAuth": {
          "id": "openrouter_api_auth",
          "name": "OpenRouter API Auth"
        }
      }
    },
    {
      "parameters": {
        "authentication": "none",
        "url": "https://n8n.pbradygeorgen.com/webhook/crew-memory-storage",
        "sendBody": true,
        "jsonParameters": true,
        "bodyParametersJson": "={{ (() => {\n  const content = ($json.choices && $json.choices[0] && $json.choices[0].message && $json.choices[0].message.content) || '';\n  const summaryLine = content.split('\\n').find(line => line.trim()) || content;\n  return {\n    body: {\n      crewMember: 'chief_obrien',\n      knowledgeType: 'troubleshooting_guide',\n      priority: 'medium',\n      title: 'Chief O\\'Brien Pragmatic Advisory',\n      summary: summaryLine.trim() || 'Pragmatic field-tested guidance',\n      detailedAnalysis: content,\n      keyFindings: [],\n      conclusions: [],\n      recommendations: [],\n      tags: ['crew', 'chief_obrien']\n    }\n  };\n})() }}"
      },
      "id": "memory_storage",
      "name": "O'Brien Memory Storage",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1136, 112]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  success: true,\n  crew_member: 'chief_obrien',\n  crew_name: \"Senior Chief Petty Officer Miles O'Brien\",\n  role: 'Engineering - Hands-On Implementation',\n  summary: $(\"Chief O'Brien AI Agent\").item.json?.choices?.[0]?.message?.content?.split('\\n').find(line => line.trim())?.trim() || $(\"Chief O'Brien AI Agent\").item.json?.choices?.[0]?.message?.content || 'No response generated.',\n  full_response: $(\"Chief O'Brien AI Agent\").item.json?.choices?.[0]?.message?.content || null,\n  request: $(\"Chief O'Brien Directive\").item.json || null,\n  memory: $(\"O'Brien Memory Storage\").item.json || null,\n  metadata: {\n    generated_at: $now,\n    model: $(\"Chief O'Brien AI Agent\").item.json?.model || null,\n    usage: $(\"Chief O'Brien AI Agent\").item.json?.usage || null,\n    pragmatic_mode: $(\"Pragmatic Analysis\").item.json?.chiefMode || null\n  }\n} }}",
        "options": {}
      },
      "id": "webhook_response",
      "name": "Send O'Brien's Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1136, 304]
    }
  ],
  "connections": {
    "crew_directive": {
      "main": [
        [
          {
            "node": "memory_retrieval",
            "type": "main",
            "index": 0
          },
          {
            "node": "pragmatic_analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "memory_retrieval": {
      "main": [
        [
          {
            "node": "pragmatic_analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pragmatic_analysis": {
      "main": [
        [
          {
            "node": "crew_ai",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "crew_ai": {
      "main": [
        [
          {
            "node": "memory_storage",
            "type": "main",
            "index": 0
          },
          {
            "node": "webhook_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null
}

